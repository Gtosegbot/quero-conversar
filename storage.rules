rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // FUNÇÕES AUXILIARES
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
        (request.auth.token.admin == true ||
         request.auth.token.email.matches('.*gtosegbot@.*') ||
         request.auth.token.email.matches('.*admgtoseg@.*') ||
         request.auth.token.email == 'disparoseguroback@gmail.com');
    }
    
    function isValidFileType(allowedTypes) {
      return request.resource.contentType.matches(allowedTypes);
    }
    
    function isValidFileSize(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }
    
    // ============================================
    // DOCUMENTOS DE PROFISSIONAIS
    // ============================================
    
    match /professional_docs/{userId}/{fileName} {
      // Leitura: qualquer usuário autenticado (para moderação)
      allow read: if isAuthenticated();
      
      // Escrita: apenas o próprio profissional
      allow write: if isOwner(userId) && 
                      isValidFileType('image/.*|application/pdf') &&
                      isValidFileSize(10);
      
      // Deleção: próprio usuário ou admin
      allow delete: if isOwner(userId) || isSuperAdmin();
    }
    
    // ============================================
    // DOCUMENTOS DE PARCEIROS
    // ============================================
    
    // ============================================
    // DOCUMENTOS DE PARCEIROS
    // ============================================
    
    match /partner_docs/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) && isValidFileType('image/.*|application/pdf') && isValidFileSize(10);
      allow delete: if isOwner(userId) || isSuperAdmin();
    }

    // ============================================
    // IMAGENS DE PRODUTOS
    // ============================================

    match /products/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) && isValidFileType('image/.*') && isValidFileSize(5);
      allow delete: if isOwner(userId) || isSuperAdmin();
    }

    // ============================================
    // CONTEÚDO DE PARCEIROS (Thumbnails/Vídeos)
    // ============================================

    match /partner_content/{userId}/{fileName} {
      allow read: if isAuthenticated();
      // Permitir imagens e vídeos até 500MB (para vídeos curtos ou cursos)
      allow write: if isOwner(userId) && isValidFileSize(500); 
      allow delete: if isOwner(userId) || isSuperAdmin();
    }
    
    // ============================================
    // BASE DE CONHECIMENTO (RAG)
    // ============================================
    
    match /knowledge_base/{userId}/{fileName} {
      // Leitura: qualquer usuário autenticado
      allow read: if isAuthenticated();
      
      // Escrita: apenas super admin
      allow write: if isSuperAdmin() && 
                      isValidFileType('application/pdf') &&
                      isValidFileSize(50); // PDFs podem ser maiores
      
      // Deleção: apenas super admin
      allow delete: if isSuperAdmin();
    }
    
    // ============================================
    // DOCUMENTOS GERAIS (Perfil de usuário)
    // ============================================
    
    match /documents/{userId}/{fileName} {
      // Leitura: próprio usuário ou admin
      allow read: if isOwner(userId) || isSuperAdmin();
      
      // Escrita: próprio usuário (verificação de tipo relaxada para debugging)
      allow write: if isOwner(userId);
      
      // Deleção: próprio usuário ou admin
      allow delete: if isOwner(userId) || isSuperAdmin();
    }
    
    // ============================================
    // AVATARES DE USUÁRIOS
    // ============================================
    
    match /avatars/{userId}/{fileName} {
      // Leitura: qualquer usuário autenticado
      allow read: if isAuthenticated();
      
      // Escrita: apenas o próprio usuário
      allow write: if isOwner(userId) && 
                      isValidFileType('image/.*') &&
                      isValidFileSize(5);
      
      // Deleção: próprio usuário ou admin
      allow delete: if isOwner(userId) || isSuperAdmin();
    }
    
    // ============================================
    // PODCASTS (Gerados pela IA)
    // ============================================
    
    match /podcasts/{fileName} {
      // Leitura: qualquer usuário autenticado
      allow read: if isAuthenticated();
      
      // Escrita: apenas admin (gerado por Cloud Function)
      allow write: if isSuperAdmin();
      
      // Deleção: apenas admin
      allow delete: if isSuperAdmin();
    }
    
    // ============================================
    // DOCUMENTOS DE USUÁRIOS (Uploads gerais)
    // ============================================
    
    match /user_documents/{userId}/{fileName} {
      // Leitura: apenas o próprio usuário
      allow read: if isOwner(userId) || isSuperAdmin();
      
      // Escrita: apenas o próprio usuário
      allow write: if isOwner(userId) && 
                      isValidFileType('image/.*|application/pdf|application/msword|application/vnd.*') &&
                      isValidFileSize(20);
      
      // Deleção: próprio usuário ou admin
      allow delete: if isOwner(userId) || isSuperAdmin();
    }
    
    // ============================================
    // VÍDEOS (Se houver)
    // ============================================
    
    match /videos/{videoId}/{fileName} {
      // Leitura: qualquer usuário autenticado
      allow read: if isAuthenticated();
      
      // Escrita: apenas admin
      allow write: if isSuperAdmin();
      
      // Deleção: apenas admin
      allow delete: if isSuperAdmin();
    }
    
    // ============================================
    // REGRA PADRÃO - NEGAR TUDO
    // ============================================
    
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
