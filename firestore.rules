rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNÇÕES AUXILIARES
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth.token.admin == true;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
        (request.auth.token.email == 'gtosegbot@gmail.com' || 
         request.auth.token.email == 'admgtoseg@gmail.com' || 
         request.auth.token.email.matches('.*gtosegbot@.*') ||
         request.auth.token.email.matches('.*admgtoseg@.*') ||
         request.auth.token.email == 'disparoseguroback@gmail.com');
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isCompanyAdmin(companyId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id == companyId &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_role == 'admin';
    }
    
    function belongsToCompany(companyId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id == companyId;
    }

    // ============================================
    // USUÁRIOS
    // ============================================

    match /users/{userId} {
      allow read: if isAuthenticated();
      
      // Apenas o próprio usuário pode editar seu perfil ou admin
      allow write: if isOwner(userId) || isAdmin();
    }

    // ============================================
    // PAGAMENTOS
    // ============================================

    match /payments/{paymentId} {
      // Leitura: apenas o próprio usuário ou admin
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isSuperAdmin());
      
      // Criação: apenas o próprio usuário (registrando pagamento)
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Atualização/Deleção: apenas admin (histórico imutável para usuários)
      allow update, delete: if isSuperAdmin();
    }
    
    // ============================================
    // SALAS DA COMUNIDADE
    // ============================================
    
    match /community_rooms/{roomId} {
      // Qualquer usuário autenticado pode ler salas
      allow read: if isAuthenticated();
      
      // Criar sala: usuário autenticado (será validado no frontend)
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid;
      
      // Atualizar/Deletar: apenas criador ou admin
      allow update, delete: if isAuthenticated() && 
        (resource.data.createdBy == request.auth.uid || isSuperAdmin());
    }
    
    // ============================================
    // MENSAGENS DA COMUNIDADE - ISOLAMENTO POR SALA
    // ============================================
    
    match /community_messages/{messageId} {
      // Leitura: qualquer usuário autenticado pode ler mensagens
      // (o isolamento é feito pela query no frontend com where('roomId', '==', roomId))
      allow read: if isAuthenticated();
      
      // Criação: apenas o próprio usuário pode criar mensagens
      allow create: if isAuthenticated() && 
        request.resource.data.user_id == request.auth.uid &&
        request.resource.data.roomId != null &&
        request.resource.data.content != null;
      
      // Atualização/Deleção: apenas o autor ou admin
      allow update, delete: if isAuthenticated() && 
        (resource.data.user_id == request.auth.uid || isSuperAdmin());
    }
    
    // ============================================
    // APLICAÇÕES DE PROFISSIONAIS
    // ============================================
    
    match /professional_applications/{applicationId} {
      // Leitura: apenas o próprio candidato ou admin
      allow read: if isAuthenticated() && 
        (request.auth.uid == applicationId || isSuperAdmin());
      
      // Criação: apenas o próprio usuário
      allow create: if isAuthenticated() && 
        request.auth.uid == applicationId &&
        request.resource.data.userId == request.auth.uid;
      
      // Atualização/Deleção: apenas admin (para aprovação)
      allow update, delete: if isSuperAdmin();
    }
    
    // ============================================
    // APLICAÇÕES DE PARCEIROS
    // ============================================
    
    match /partner_applications/{applicationId} {
      // Leitura: apenas o próprio candidato ou admin
      allow read: if isAuthenticated() && 
        (request.auth.uid == applicationId || isSuperAdmin());
      
      // Criação: apenas o próprio usuário
      allow create: if isAuthenticated() && 
        request.auth.uid == applicationId &&
        request.resource.data.userId == request.auth.uid;
      
      // Atualização/Deleção: apenas admin (para aprovação)
      allow update, delete: if isSuperAdmin();
    }
    
    // ============================================
    // EMPRESAS - ISOLAMENTO POR EMPRESA
    // ============================================
    
    match /companies/{companyId} {
      // Leitura: Se usuário é membro, admin, dono ou super admin.
      // Simplificado: Se autenticado, pode ler documento específico se souber o ID e tiver relação.
      allow read: if isAuthenticated() && 
        (belongsToCompany(companyId) || 
         resource.data.admins.hasAny([request.auth.uid]) ||
         resource.data.owner_id == request.auth.uid ||
         isSuperAdmin());
      
      // Criação: Autenticado pode criar se se definir como dono/admin.
      allow create: if isAuthenticated() && 
        (request.resource.data.owner_id == request.auth.uid || 
         request.resource.data.admins.hasAny([request.auth.uid]) ||
         request.resource.data.admin_uid == request.auth.uid);
      
      // Atualização: Admins da empresa ou Super Admin.
      allow update: if isAuthenticated() && 
        (isCompanyAdmin(companyId) || 
         resource.data.admins.hasAny([request.auth.uid]) ||
         resource.data.owner_id == request.auth.uid ||
         isSuperAdmin());
      
      allow delete: if isSuperAdmin();
    }
    
    // ============================================
    // CONTEÚDO DA EMPRESA (Uploads) - NOVO RULE
    // ============================================

    match /company_contents/{contentId} {
       // Leitura: Membros da empresa ou admin
       allow read: if isAuthenticated() && 
         (belongsToCompany(resource.data.company_id) || 
          isCompanyAdmin(resource.data.company_id) || 
          isSuperAdmin());

       // Criação: Apenas Admins da empresa
       allow create: if isAuthenticated() && 
         (isCompanyAdmin(request.resource.data.company_id) || 
          request.resource.data.uploaded_by == request.auth.uid); // Permite upload se associado ao usuário
       
       // Atualização/Deleção: Admins
       allow update, delete: if isAuthenticated() && 
         (isCompanyAdmin(resource.data.company_id) || isSuperAdmin());
    }
    
    // ============================================
    // FUNCIONÁRIOS - ISOLAMENTO POR EMPRESA
    // ============================================
    
    match /company_employees/{employeeId} {
      // Leitura
      allow get: if isAuthenticated();
      allow list: if isAuthenticated();
      
      // Criação: Relaxada para permitir "seeding" e auto-cura
      allow create: if isAuthenticated(); 
      
      // Atualização: Admin ou o próprio funcionário
      allow update: if isAuthenticated() && 
        (isCompanyAdmin(resource.data.company_id) || 
         resource.data.user_id == request.auth.uid);
      
      // Deleção: Admin
      allow delete: if isAuthenticated() && 
        (isCompanyAdmin(resource.data.company_id) || isSuperAdmin());
    }
    
    // ============================================
    // CONVITES DE FUNCIONÁRIOS
    // ============================================
    
    match /employee_invites/{inviteId} {
      allow read: if isAuthenticated();
      
      // Criação: Simplificada para garantir que invite funcione se autenticado e tiver company_id
      allow create: if isAuthenticated() && 
        (isCompanyAdmin(request.resource.data.company_id) || 
         request.resource.data.invited_by == request.auth.uid);
      
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // BASE DE CONHECIMENTO (RAG)
    // ============================================
    
    match /knowledge_base/{docId} {
      // Leitura: qualquer usuário autenticado
      allow read: if isAuthenticated();
      
      // Escrita: apenas admin
      allow write: if isSuperAdmin();
    }
    
    // ============================================
    // INSIGHTS DO ADMIN (Curador IA)
    // ============================================
    
    match /admin_insights/{insightId} {
      // Leitura: apenas admin
      allow read: if isSuperAdmin();
      
      // Escrita: apenas admin
      allow write: if isSuperAdmin();
    }
    
    // ============================================
    // PODCASTS
    // ============================================
    
    match /podcasts/{podcastId} {
      // Leitura: qualquer usuário autenticado
      allow read: if isAuthenticated();
      
      // Escrita: apenas admin
      allow write: if isSuperAdmin();
    }
    
    // ============================================
    // NOTIFICAÇÕES
    // ============================================
    
    match /notifications/{notificationId} {
      // Leitura: qualquer usuário autenticado
      allow read: if isAuthenticated();
      
      // Escrita: apenas admin
      allow write: if isSuperAdmin();
    }
    
    // ============================================
    // TEMPLATES DE TAREFAS
    // ============================================
    
    match /task_templates/{templateId} {
      // Leitura: qualquer usuário autenticado
      allow read: if isAuthenticated();
      
      // Escrita: apenas admin
      allow write: if isSuperAdmin();
    }
    
    match /moderator_chat/{messageId} {
      // Apenas admin
      allow read, write: if isSuperAdmin();
    }
    
    // ============================================
    // CONVERSAS (Chat com Dra. Clara)
    // ============================================

    // Regra Global para Collection Group Queries de Mensagens (Admin Stats)
    match /{path=**}/messages/{messageId} {
      allow read: if isSuperAdmin();
    }
    
    match /conversations/{conversationId} {
      // Leitura: apenas o dono da conversa ou admin
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isSuperAdmin());
      
      // Criação: apenas o próprio usuário
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Atualização: apenas o dono
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Deleção: dono ou admin
      allow delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isSuperAdmin());
      
      // Mensagens dentro da conversa
      match /messages/{messageId} {
        // PERMISSÃO TOTAL PARA DEBUG
        allow read, write: if isAuthenticated();
      }
    }
    
    // ============================================
    // PRODUTOS DE PARCEIROS
    // ============================================

    match /products/{productId} {
      // Leitura: qualquer usuário (loja pública)
      allow read: if isAuthenticated();
      
      // Criação: parceiros autenticados
      allow create: if isAuthenticated() && 
        request.resource.data.partnerId == request.auth.uid;
      
      // Atualização/Deleção: apenas o dono ou admin
      allow update, delete: if isAuthenticated() && 
        (resource.data.partnerId == request.auth.uid || isSuperAdmin());
    }

    // ============================================
    // CONTEÚDO DE PARCEIROS (Vídeos, etc)
    // ============================================

    match /partner_content/{contentId} {
      // Leitura: qualquer usuário
      allow read: if isAuthenticated();
      
      // Criação: parceiros autenticados
      allow create: if isAuthenticated() && 
        request.resource.data.partnerId == request.auth.uid;
      
      // Atualização/Deleção: apenas o dono ou admin
      allow update, delete: if isAuthenticated() && 
        (resource.data.partnerId == request.auth.uid || isSuperAdmin());
    }

    // ============================================
    // AGENDAMENTOS
    // ============================================
    
    match /appointments/{appointmentId} {
      // Leitura: participantes do agendamento ou admin
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         resource.data.professionalId == request.auth.uid || 
         isSuperAdmin());
      
      // Criação: usuário autenticado
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Atualização: participantes ou admin
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         resource.data.professionalId == request.auth.uid || 
         isSuperAdmin());
      
      // Deleção: participantes ou admin
      allow delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         resource.data.professionalId == request.auth.uid || 
         isSuperAdmin());
    }

    // ============================================
    // CONFIGURAÇÕES PROFISSIONAIS (Agenda)
    // ============================================

    match /professional_settings/{userId} {
      // Leitura: qualquer usuário (para saber disponibilidade) ou admin
      allow read: if isAuthenticated();
      
      // Escrita: apenas o próprio profissional e admin
      allow write: if isAuthenticated() && 
        (request.auth.uid == userId || isSuperAdmin());
    }

    // ============================================
    // VÍDEOS (Biblioteca)
    // ============================================

    match /videos/{videoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        (request.resource.data.professionalId == request.auth.uid || isSuperAdmin());
      allow update, delete: if isAuthenticated() && 
        (resource.data.professionalId == request.auth.uid || isSuperAdmin());
    }

    // ============================================
    // DOCUMENTOS (Uploads de usuários/profissionais)
    // ============================================

    match /documents/{documentId} {
      // Leitura: dono do documento, profissional vinculado ou admin
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         resource.data.professionalId == request.auth.uid ||
         isSuperAdmin());
      
      // Criação: qualquer usuário autenticado (vinculando a si mesmo)
      allow create: if isAuthenticated() && 
        (request.resource.data.userId == request.auth.uid ||
         isSuperAdmin());

      // Atualização/Deleção: dono ou admin
      allow update, delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isSuperAdmin());
    }
    
    // ============================================
    // RELATÓRIOS
    // ============================================
    
    match /moderation_reports/{reportId} {
      // Apenas admin
      allow read, write: if isSuperAdmin();
    }
  }
}
